import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

st.set_page_config(layout="wide")
st.title("üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–ø–ª–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–æ ‚Ññ –û–î–ü–£")

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
df = pd.read_csv("merge3 (1).csv", encoding="cp1251", parse_dates=["–î–∞—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è"], dayfirst=True)

# –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞
df = df.dropna(subset=["–î–∞—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è", "–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª", "‚Ññ –û–î–ü–£"])
df["–ú–µ—Å—è—Ü–ì–æ–¥"] = df["–î–∞—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è"].dt.to_period("M").astype(str)
df = df.sort_values("–î–∞—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è")
df["–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª"] = pd.to_numeric(df["–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª"], errors="coerce")

# –§–∏–ª—å—Ç—Ä –ø–æ ‚Ññ –û–î–ü–£
odp_list = df["‚Ññ –û–î–ü–£"].dropna().unique()
selected_odpu = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ ‚Ññ –û–î–ü–£", odp_list)

filtered_df = df[df["‚Ññ –û–î–ü–£"] == selected_odpu].copy()
filtered_df["–†–∞–∑–Ω–∏—Ü–∞"] = filtered_df["–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª"].diff()
filtered_df["–ò–∑–º–µ–Ω–µ–Ω–∏–µ (%)"] = filtered_df["–†–∞–∑–Ω–∏—Ü–∞"] / filtered_df["–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª"].shift(1) * 100

# üìå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ
obj_info = filtered_df.iloc[-1]
st.markdown(f"""
**üìç –ê–¥—Ä–µ—Å:** {obj_info['–ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞']}  
**üè¢ –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:** {obj_info['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞']}  
**üèóÔ∏è –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏:** {obj_info['–î–∞—Ç–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'][:10]}  
**üìê –≠—Ç–∞–∂–Ω–æ—Å—Ç—å:** {obj_info['–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–∞']}  
**üìè –ü–ª–æ—â–∞–¥—å (–º¬≤):** {obj_info['–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –æ–±—ä–µ–∫—Ç–∞']}
""")

# üìâ –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
st.subheader("üìâ –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π —ç–Ω–µ—Ä–≥–∏–∏")

fig, ax = plt.subplots(figsize=(14, 6))
bars = ax.bar(filtered_df["–ú–µ—Å—è—Ü–ì–æ–¥"], filtered_df["–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª"], color='orange')
ax.set_ylabel("–ì–∫–∞–ª")
ax.set_title("–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ç–µ–ø–ª–∞ –ø–æ –º–µ—Å—è—Ü–∞–º")
ax.set_xticklabels(filtered_df["–ú–µ—Å—è—Ü–ì–æ–¥"], rotation=45)
fig.tight_layout()
st.pyplot(fig)

# üìä –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
st.subheader("üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –º–µ—Å—è—Ü–µ–º")

def highlight_anomaly(val):
    try:
        if val > 30:
            return "background-color: #ffcccc"  # –∫—Ä–∞—Å–Ω—ã–π
        elif val < -30:
            return "background-color: #ccffcc"  # –∑–µ–ª—ë–Ω—ã–π
    except:
        pass
    return ""

styled_df = filtered_df[["–ú–µ—Å—è—Ü–ì–æ–¥", "–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª", "–†–∞–∑–Ω–∏—Ü–∞", "–ò–∑–º–µ–Ω–µ–Ω–∏–µ (%)"]].style.applymap(highlight_anomaly, subset=["–ò–∑–º–µ–Ω–µ–Ω–∏–µ (%)"])
st.dataframe(styled_df, use_container_width=True)

# ‚ö†Ô∏è –ê–Ω–æ–º–∞–ª–∏–∏
st.subheader("‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏")
threshold = st.slider("–ü–æ—Ä–æ–≥ –∞–Ω–æ–º–∞–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è (%)", 10, 100, 30)
anom = filtered_df[filtered_df["–ò–∑–º–µ–Ω–µ–Ω–∏–µ (%)"].abs() > threshold]
st.write(f"–ù–∞–π–¥–µ–Ω–æ –∞–Ω–æ–º–∞–ª–∏–π: {len(anom)}")
st.dataframe(anom[["–ú–µ—Å—è—Ü–ì–æ–¥", "–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª", "–†–∞–∑–Ω–∏—Ü–∞", "–ò–∑–º–µ–Ω–µ–Ω–∏–µ (%)"]])
