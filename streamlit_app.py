import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

st.set_page_config(layout="wide")
st.title("üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–ø–ª–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –ø–æ ‚Ññ –û–î–ü–£")

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
df = pd.read_csv("merge3 (1).csv", encoding="cp1251")

# –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –¥–∞—Ç—ã –∫ –Ω—É–∂–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
df["–î–∞—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è"] = pd.to_datetime(df["–î–∞—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è"], errors="coerce")
df["–ú–µ—Å—è—Ü–ì–æ–¥"] = df["–î–∞—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è"].dt.to_period("M").astype(str)

# UI: –í—ã–±–æ—Ä –û–î–ü–£
selected_odpu = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ ‚Ññ –û–î–ü–£", df["‚Ññ –û–î–ü–£"].unique())

# –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –û–î–ü–£
filtered_df = df[df["‚Ññ –û–î–ü–£"] == selected_odpu]

# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
grouped = filtered_df.groupby("–ú–µ—Å—è—Ü–ì–æ–¥")["–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª"].sum().reset_index()

# –°–ª–æ–≤–∞—Ä—å —Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–º–∏
temperature_map = {
    "2021-07": None, "2021-08": None, "2021-09": None, "2021-10": 6.70, "2021-11": -1, "2021-12": -5.18,
    "2022-01": -11.50, "2022-02": -6.74, "2022-03": -5.15, "2022-04": 5.65, "2022-05": None, "2022-06": None,
    "2022-07": None, "2022-08": None, "2022-09": None, "2022-10": 7.14, "2022-11": -1.61, "2022-12": -10.90,
    "2023-01": -12.75, "2023-02": -8.94, "2023-03": -2.27, "2023-04": 7.82, "2023-05": None, "2023-06": None
}

# –î–æ–±–∞–≤–∏–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∫ –¥–∞–Ω–Ω—ã–º
grouped["–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C"] = grouped["–ú–µ—Å—è—Ü–ì–æ–¥"].map(temperature_map)

# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
fig, ax1 = plt.subplots(figsize=(12, 6))

# –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ ‚Äî –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ
ax1.bar(grouped["–ú–µ—Å—è—Ü–ì–æ–¥"], grouped["–¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª"], color='orange', label="–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª")
ax1.set_ylabel("–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –ì–∫–∞–ª", color="orange")
ax1.tick_params(axis='y', labelcolor="orange")
plt.xticks(rotation=45)

# –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
ax2 = ax1.twinx()
ax2.plot(grouped["–ú–µ—Å—è—Ü–ì–æ–¥"], grouped["–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C"], color="blue", marker="o", label="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C")
ax2.set_ylabel("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C", color="blue")
ax2.tick_params(axis='y', labelcolor="blue")

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ª–µ–≥–µ–Ω–¥–∞
plt.title("–ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã")
fig.tight_layout()
st.pyplot(fig)
